apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"
apply plugin: "io.sentry.android.gradle"
apply plugin: "com.google.gms.google-services"

def projectRoot = rootDir.getAbsoluteFile().getParentFile().getAbsolutePath()

/** React Native / Expo config */
react {
  entryFile = file(["node", "-e", "require('expo/scripts/resolveAppEntry')", projectRoot, "android", "absolute"].execute(null, rootDir).text.trim())
  reactNativeDir = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()
  hermesCommand = new File(["node", "--print", "require.resolve('react-native/package.json')"].execute(null, rootDir).text.trim()).getParentFile().getAbsolutePath() + "/sdks/hermesc/%OS-BIN%/hermesc"
  codegenDir = new File(["node", "--print", "require.resolve('@react-native/codegen/package.json', { paths: [require.resolve('react-native/package.json')] })"].execute(null, rootDir).text.trim()).getParentFile().getAbsoluteFile()
  cliFile = new File(["node", "--print", "require.resolve('@expo/cli', { paths: [require.resolve('expo/package.json')] })"].execute(null, rootDir).text.trim())
  bundleCommand = "export:embed"
  autolinkLibrariesWithApp()
}

/** RN plugin override for Hermes bundling / source maps (as in your project) */
project.ext.react = [
  bundleCommand: "ram-bundle",
  bundleAssetName: "index.bundle",
  entryFile: "index.js",
  hermesCommand: "../../node_modules/hermes-engine/%OS-BIN%/hermesc",
  cliPath: "../../node_modules/react-native/cli.js",
  composeSourceMapsPath: "../../node_modules/react-native/scripts/compose-source-maps.js",
]

/** Misc vars used later */
def enableProguardInReleaseBuilds = true
def jscFlavor = 'org.webkit:android-jsc:+'

/** Android config — explicit versions to avoid “compileSdkVersion not specified” */
android {
  ndkVersion "26.1.10909125"
  buildToolsVersion "34.0.0"
  compileSdkVersion 34
  namespace "io.metamask"

  defaultConfig {
    applicationId "io.metamask"
    minSdkVersion 24
    targetSdkVersion 34

    versionName "7.46.2"
    versionCode 1891

    testBuildType System.getProperty('testBuildType', 'debug')
    testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"

    manifestPlaceholders.MM_BRANCH_KEY_TEST = "$System.env.MM_BRANCH_KEY_TEST"
    manifestPlaceholders.MM_BRANCH_KEY_LIVE = "$System.env.MM_BRANCH_KEY_LIVE"
  }

  /* Matches your original packaging block */
  packagingOptions {
    exclude 'META-INF/DEPENDENCIES'
    pickFirst 'lib/x86/libc++_shared.so'
    pickFirst 'lib/x86_64/libc++_shared.so'
    pickFirst 'lib/armeabi-v7a/libc++_shared.so'
    pickFirst 'lib/arm64-v8a/libc++_shared.so'
    pickFirst 'lib/arm64-v8a/libcrypto.so'
    pickFirst 'lib/armeabi-v7a/libcrypto.so'
    pickFirst 'lib/x86/libcrypto.so'
    pickFirst 'lib/x86_64/libcrypto.so'
    jniLibs {
      // keep expo legacy switch
      useLegacyPackaging (findProperty('expo.useLegacyPackaging')?.toBoolean() ?: false)
    }
    exclude 'META-INF/AL2.0'
    exclude 'META-INF/LGPL2.1'
  }

  androidResources {
    ignoreAssetsPattern '!.svn:!.git:!.ds_store:!*.scc:!CVS:!thumbs.db:!picasa.ini:!*~'
  }

  /* ⚠️ These signing configs match what you had — if you really use them, fine.
     Otherwise consider moving secrets to gradle.properties or env vars. */
  signingConfigs {
    release {
      storeFile file('my-release-key.jks')
      storePassword 'dtsinc123'
      keyAlias 'my-alias'
      keyPassword 'dtsinc123'
    }
    qa {
      storeFile file('../keystores/internalRelease.keystore')
      storePassword System.getenv("BITRISEIO_ANDROID_QA_KEYSTORE_PASSWORD")
      keyAlias System.getenv("BITRISEIO_ANDROID_QA_KEYSTORE_ALIAS")
      keyPassword System.getenv("BITRISEIO_ANDROID_QA_KEYSTORE_PRIVATE_KEY_PASSWORD")
    }
    debug {
      storeFile file('debug.keystore')
      storePassword 'android'
      keyAlias 'androiddebugkey'
      keyPassword 'android'
    }
    flask {
      storeFile file('my-release-key.jks')
      storePassword 'dtsinc123'
      keyAlias 'my-alias'
      keyPassword 'dtsinc123'
    }
  }

  buildTypes {
    debug {
      manifestPlaceholders.isDebug = true
      signingConfig signingConfigs.debug
    }
    release {
      manifestPlaceholders.isDebug = false
      minifyEnabled enableProguardInReleaseBuilds
      proguardFiles getDefaultProguardFile("proguard-android.txt"),
        "proguard-rules.pro",
        "${rootProject.projectDir}/../node_modules/detox/android/detox/proguard-rules-app.pro",
        "${rootProject.projectDir}/../node_modules/detox/android/detox/proguard-rules.pro"
      crunchPngs (findProperty('android.enablePngCrunchInReleaseBuilds')?.toBoolean() ?: true)
      testProguardFiles getDefaultProguardFile("proguard-android.txt"),
        "proguard-rules.pro",
        "${rootProject.projectDir}/../node_modules/detox/android/detox/proguard-rules-app.pro",
        "${rootProject.projectDir}/../node_modules/detox/android/detox/proguard-rules.pro"
      // choose signing config in flavors below
    }
  }

  flavorDimensions "version"
  productFlavors {
    qa {
      dimension "version"
      applicationIdSuffix ".qa"
      applicationId "io.metamask"
      signingConfig signingConfigs.qa
    }
    prod {
      dimension "version"
      applicationId "io.metamask"
      signingConfig signingConfigs.release
    }
    flask {
      dimension "version"
      applicationIdSuffix ".flask"
      applicationId "io.metamask"
      // Use the appropriate signing config based on environment
      if (System.getenv("METAMASK_ENVIRONMENT") == 'qa') {
        signingConfig signingConfigs.qa
      } else {
        signingConfig signingConfigs.flask
      }
    }
  }

  buildTypes.each {
    it.buildConfigField 'String', 'foxCode', "\"$System.env.MM_FOX_CODE\""
    it.buildConfigField 'String', 'IS_RAMP_UAT', "\"$System.env.RAMP_INTERNAL_BUILD\""
    it.buildConfigField 'String', 'IS_RAMP_DEV', "\"$System.env.RAMP_DEV_BUILD\""
  }

  buildFeatures {
    buildConfig = true
  }
}

/** Dependencies */
dependencies {
  // The version of react-native is set by the React Native Gradle Plugin
  implementation(files("../libs/ecies.aar"))
  implementation(files("../libs/nativesdk.aar"))
  implementation("com.facebook.react:react-android")
  implementation 'org.apache.commons:commons-compress:1.22'
  androidTestImplementation 'androidx.test:core:1.5.0'
  androidTestImplementation 'androidx.test:core-ktx:1.5.0'

  if (hermesEnabled.toBoolean()) {
    implementation("com.facebook.react:hermes-android")
  } else {
    implementation jscFlavor
  }

  androidTestImplementation('com.wix:detox:+') {
    exclude module: "protobuf-lite"
  }
  androidTestImplementation('androidx.test.espresso:espresso-contrib:3.4.0')

  androidTestImplementation "com.google.guava:guava:31.1-android"
  androidTestImplementation "org.ow2.asm:asm:9.4"
  androidTestImplementation "net.java.dev.jna:jna:5.12.1"
  androidTestImplementation "net.java.dev.jna:jna-platform:5.12.1"
  androidTestImplementation "org.opentest4j:opentest4j:1.2.0"

  /* ✅ Force use of patched WebView module from source */
  implementation project(':metamask_react-native-webview')
}

/** Sentry plugin placeholder (kept off like your original) */
sentry {
  autoUploadProguardMapping.set(false)
  autoInstallation {
    enabled = false
  }
}
